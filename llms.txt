# nullcat

`nullcat` provides null model algorithms for categorical and
quantitative community ecology data. It extends classic **binary** null
models (e.g., curveball, swap) to work with **categorical** data, and
introduces a stratified randomization framework for **continuous** data
that addresses limitations in existing quantitative null model methods.

## Installation

The package is currently in development. Install from GitHub:

``` r
# install.packages("remotes")
remotes::install_github("matthewkling/nullcat")
```

## Key functionality

### 1. Categorical null models

`nullcat` generalizes binary null model algorithms to handle categorical
data (site-by-species matrices of integers representing discrete strata
or categories):

- **`curvecat`**: Categorical curveball algorithm
- **`swapcat`**: Categorical 2x2 swap algorithm  
- **`tswapcat`**: Categorical trial-swap algorithm
- **`r0cat`**: Row-constrained randomization (fixed row margins)
- **`c0cat`**: Column-constrained randomization (fixed column margins)

These algorithms preserve the multiset of categories in fixed margins
(rows and/or columns) while randomizing their spatial arrangement.

### 2. Stratified quantitative null models

The
[`quantize()`](https://matthewkling.github.io/nullcat/reference/quantize.md)
function provides a principled approach to randomizing quantitative
community data (abundance, biomass, cover, SDM probabilities):

1.  **Stratify**: Convert continuous values into discrete strata
2.  **Randomize**: Apply categorical null model to stratified matrix
3.  **Reassign**: Map randomized strata back to original quantitative
    values

This approach offers greater control and transparency compared to
existing quantitative null model methods, with flexible options for:

- Number and definition of strata
- Value transformations (log, sqrt, rank, etc.)
- Preservation levels (cell, stratum, row, or column)
- Multiple randomization algorithms

### 3. Diagnostic & utility functions

- **[`trace_cat()`](https://matthewkling.github.io/nullcat/reference/trace_cat.md)**:
  Trace mixing diagnostics for MCMC convergence
- **[`suggest_n_iter()`](https://matthewkling.github.io/nullcat/reference/suggest_n_iter.md)**:
  Automatically suggest burn-in iterations
- **[`quantize_prep()`](https://matthewkling.github.io/nullcat/reference/quantize_prep.md)**:
  Pre-compute overhead for efficient repeated randomization
- **[`quantize_batch()`](https://matthewkling.github.io/nullcat/reference/quantize_batch.md)**:
  Generate null distributions with optional parallelization
- **`commsim_cat()` & `commsim_cat_seq()`**: Integration with `vegan`
  null model workflows

All core algorithms are implemented in C++ via Rcpp for computational
efficiency.

## Quick start

### Categorical data

``` r
library(nullcat)

# Create a categorical matrix (e.g., strata or discrete abundance classes)
set.seed(123)
cat_matrix <- matrix(sample(1:4, 20*10, replace = TRUE), nrow = 20)

# Randomize using curvecat (preserves row & column category multisets)
randomized <- curvecat(cat_matrix, n_iter = 1000)

# Compare margins
all.equal(sort(cat_matrix[1,]), sort(randomized[1,]))  # Row preserved
#> [1] TRUE
all.equal(sort(cat_matrix[,1]), sort(randomized[,1]))  # Column preserved
#> [1] TRUE
```

### Quantitative data

``` r
# Create a quantitative community matrix
set.seed(456)
comm <- matrix(rexp(50 * 30, rate = 0.5), nrow = 50,
               dimnames = list(paste0("site", 1:50),
                               paste0("sp", 1:30)))

# Default: curvecat-backed stratified randomization
rand1 <- quantize(comm, n_strata = 5, n_iter = 2000)

# Preserve row value multisets
rand2 <- quantize(comm, n_strata = 5, fixed = "row", n_iter = 2000)

# Check row sums are preserved when fixed = "row"
all.equal(rowSums(comm), rowSums(rand2))
#> [1] TRUE
```

### Trace diagnostics

``` r
# Assess mixing behavior
set.seed(789)
x <- matrix(sample(1:5, 2000, replace = TRUE), 40)

trace <- trace_cat(x, fun = "nullcat", method = "curvecat",
                   n_iter = 1000, n_chains = 5, thin = 10)
plot(trace)
```

![](reference/figures/README-trace-diagnostics-1.png)

``` r

# Get burn-in recommendation
suggested <- suggest_n_iter(trace, tail_frac = 0.3)
print(suggested)
#> suggested_n_iter object
#> -----------------------
#> Converged: TRUE 
#> Suggested n iterations: 260
```

### Efficient repeated randomization

``` r
# Generate null distribution of randomized matrices
set.seed(101)
comm <- matrix(rexp(30 * 20), nrow = 30)
null_dist <- quantize_batch(comm, n_reps = 999, 
                           n_strata = 4, fixed = "row",
                           n_cores = 5)  # Set n_cores > 1 for parallelization
```

## Integration with vegan

``` r
library(vegan)

# Create commsim object for categorical data
cs <- commsim_cat_seq(method = "curvecat")

# Use with vegan's nullmodel framework
nm <- nullmodel(cat_matrix, method = cs)
sims <- simulate(nm, nsim = 99, burnin = 1000, thin = 100)
```

------------------------------------------------------------------------

**Development Status**: This package is under active development. The
API may change before the initial CRAN release. Feedback and
contributions are welcome.

# Package index

## Categorical randomizations

- [`nullcat()`](https://matthewkling.github.io/nullcat/reference/nullcat.md)
  : Categorical matrix randomization
- [`nullcat_batch()`](https://matthewkling.github.io/nullcat/reference/nullcat_batch.md)
  : Generate a batch of null matrices using \`nullcat()\`
- [`nullcat_methods()`](https://matthewkling.github.io/nullcat/reference/nullcat_methods.md)
  : Supported nullcat methods
- [`c0cat()`](https://matthewkling.github.io/nullcat/reference/c0cat.md)
  : Column-constrained categorical randomization (c0cat)
- [`curvecat()`](https://matthewkling.github.io/nullcat/reference/curvecat.md)
  : Categorical curveball randomization (curvecat)
- [`r0cat()`](https://matthewkling.github.io/nullcat/reference/r0cat.md)
  : Row-constrained categorical randomization (r0cat)
- [`swapcat()`](https://matthewkling.github.io/nullcat/reference/swapcat.md)
  : Categorical swap randomization (swapcat)
- [`tswapcat()`](https://matthewkling.github.io/nullcat/reference/tswapcat.md)
  : Trial-swap categorical randomization (tswapcat)

## Quantize routines

- [`quantize()`](https://matthewkling.github.io/nullcat/reference/quantize.md)
  : Stratified randomization of a quantitative community matrix
- [`quantize_batch()`](https://matthewkling.github.io/nullcat/reference/quantize_batch.md)
  : Generate a batch of null matrices using \`quantize()\`
- [`quantize_prep()`](https://matthewkling.github.io/nullcat/reference/quantize_prep.md)
  : Prepare stratified null model overhead for quantize()
- [`stratify()`](https://matthewkling.github.io/nullcat/reference/stratify.md)
  : Bin quantitative data into strata

## Mixing diagnostics

- [`suggest_n_iter()`](https://matthewkling.github.io/nullcat/reference/suggest_n_iter.md)
  : Suggest a reasonable n_iter for a randomization
- [`trace_cat()`](https://matthewkling.github.io/nullcat/reference/trace_cat.md)
  : Trace diagnostics for categorical randomizations
- [`kappa()`](https://matthewkling.github.io/nullcat/reference/kappa.md)
  : Cohen's kappa for categorical data

## Vegan integration

- [`nullcat_commsim()`](https://matthewkling.github.io/nullcat/reference/nullcat_commsim.md)
  : Nullcat-based commsim (non-sequential)
- [`nullcat_commsim_seq()`](https://matthewkling.github.io/nullcat/reference/nullcat_commsim_seq.md)
  : Nullcat-based commsim (sequential / Markov chain)
- [`quantize_commsim()`](https://matthewkling.github.io/nullcat/reference/quantize_commsim.md)
  : Quantize-based commsim (non-sequential)
- [`quantize_commsim_seq()`](https://matthewkling.github.io/nullcat/reference/quantize_commsim_seq.md)
  : Quantile-based quantize commsim (sequential / Markov chain)

